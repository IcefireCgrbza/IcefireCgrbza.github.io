---
title: 4.事务机制
date: 2021-04-21 19:59:01
tags: 九、Mysql
categories: 九、Mysql
---

# 事务

我们可以通过 set session autoCommit = on/off 来设置mysql事务是否自动开启

如果我们设置autoCommit为off的时候，我们需要手动开启mysql事务

begin；start transaction；----开启事务（2选1）

通过 commit；或者 rollback；设置事务提交或者回滚

事务有四大特性（ACID）：

+ 原子性：数据流动，A-B+
+ 一致性：保证每次事务结束后的状态一致
+ 隔离性：事务间隔离
+ 持久性：事务提交后永久生效

# 四大隔离级别

+ 读未提交：A事务可以读到B事务未提交的数据
+ 读已提交：A事务只能读其他事务已提交的数据。这是大多数据库的默认隔离级别，会导致脏读（两次查询结果不一样）
+ 可重复读：解决了脏读的问题，但可能导致幻读（个人认为，幻读指的是查询时只有一条记录，却更新了不止一条记录）
+ 串行：加锁

# MVCC

+ binlog：事务提交后的日志，可用于主从复制
+ redolog：未提交的日志，可用于数据恢复
+ undolog：回滚的日志，可用于事务回滚

MVCC 全称是多版本并发控制系统，用于解决事务并发时锁开销的问题。InnoDB的MVCC是通过在每行记录后面保存两个隐藏的列来实现，这两个列一个保存了行的创建的事务版本号，一个保存行的删除的事务版本号。每开始一个新的事务，事务版本号都会自动递增，作为事务的版本号。下面是他的核心原理（实际上是通过一种叫ReadView的机制去做的，记录的是事务号和undolog，详细机制以后有机会看mysql源码的时候再研究吧）

+ 新建时，将事务版本号写入创建的版本号
+ 删除时，新建一条数据，将事务的版本号写入老数据的删除版本号
+ 查询时，只能查到创建的版本号小于等于事务版本号的记录 且 删除版本号为空 或 删除版本号大于当前事务版本号的记录
